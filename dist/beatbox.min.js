Beatbox=function(t,e,i){this.playing=!1,this._pattern=t,this._strokeLength=e,this._repeat=i,this._timeout=null,this._timeout2=null,this._players=[],this._position=0,this._referenceTime=null},Beatbox._cacheLength=1200,Beatbox._webAudio=Howler.usingWebAudio,Beatbox._instruments={},Beatbox.registerInstrument=function(t,e){Beatbox._instruments[t]=e},Beatbox._playWhen=function(t,e,i){Beatbox._whenOverride=e;try{t.play(i),clearTimeout(t._onendTimer.pop().timer)}finally{Beatbox._whenOverride=null}},Beatbox.prototype.play=function(){this.playing||(this.playing=!0,Beatbox._webAudio?this._playUsingWebAudio():this._playUsingTimeout(),this.onplay&&this.onplay())},Beatbox.prototype.stop=function(){this.playing&&(clearTimeout(this._timeout),this._timeout=null,this._timeout2&&(clearTimeout(this._timeout2),this._timeout2=null),Beatbox._webAudio&&(this._position=this.getPosition(),this._clearWebAudioCache()),this.playing=!1,this.onstop&&this.onstop())},Beatbox.prototype.getPosition=function(){if(Beatbox._webAudio&&this.playing){for(var t=1e3*(Howler.ctx.currentTime-this._referenceTime)/this._strokeLength;0>t;)t+=this._pattern.length;return Math.floor(t)}return this._position},Beatbox.prototype.setPosition=function(t){var e=this.playing;e&&this.stop(),this._position=null!=t?t:0,e&&this.play()},Beatbox.prototype.setPattern=function(t){this._pattern=t,this._applyChanges()},Beatbox.prototype.setBeatLength=function(t){if(Beatbox._webAudio){this._clearWebAudioCache(Howler.ctx.currentTime+1e-6);for(var e=1e3*(Howler.ctx.currentTime-this._referenceTime)/this._strokeLength;0>e;)e+=this._pattern.length;this._referenceTime=Howler.ctx.currentTime-e*t/1e3}this._strokeLength=t,this._applyChanges()},Beatbox.prototype.setRepeat=function(t){this._repeat=t,this._applyChanges()},Beatbox.prototype._applyChanges=function(){if(Beatbox._webAudio&&this.playing){for(this._position=this.getPosition()+1;this._referenceTime>Howler.ctx.currentTime;)this._referenceTime-=this._pattern.length*this._strokeLength/1e3;this._fillWebAudioCache()}},Beatbox.prototype._playUsingTimeout=function(){if(this.onbeat&&this.onbeat(this._position),this._pattern[this._position])for(var t=0;t<this._pattern[this._position].length;t++)Beatbox._instruments[this._pattern[this._position][t]].play();var e=this;this._timeout=setTimeout(function(){return++e._position>=e._pattern.length&&(e._position=0,!e._repeat)?void(e.onstop&&e.onstop()):void e._playUsingTimeout()},this._strokeLength)},Beatbox.prototype._playUsingWebAudio=function(){this._referenceTime=Howler.ctx.currentTime-this._position*this._strokeLength/1e3;var t=this,e=function(){t._timeout=t._fillWebAudioCache()===!1?setTimeout(function(){t.stop(),t._position=0,t.onstop&&t.onstop()},1e3*t._referenceTime+t._strokeLength*t._pattern.length-1e3*Howler.ctx.currentTime):setTimeout(e,.8*Beatbox._cacheLength)};if(e(),this.onbeat){var i=function(){t.onbeat(t.getPosition());var e=1e3*(Howler.ctx.currentTime-t._referenceTime)%t._strokeLength;0>e&&(e+=t._strokeLength),t._timeout2=setTimeout(i,t._strokeLength-e)};i()}},Beatbox.prototype._fillWebAudioCache=function(){this._clearWebAudioCache(this._referenceTime+this._position*this._strokeLength/1e3);for(var t=this,e=Math.ceil(Beatbox._cacheLength/this._strokeLength),i=0;e>i;i++,this._position++){if(this._position>=this._pattern.length){if(!this._repeat)return!1;this._position=0,this._referenceTime=this._referenceTime+this._strokeLength*this._pattern.length/1e3}if(this._pattern[this._position])for(var o=0;o<this._pattern[this._position].length;o++)!function(){var e=Beatbox._instruments[t._pattern[t._position][o]];if(e){var i=t._referenceTime+t._position*t._strokeLength/1e3;Beatbox._playWhen(e,i,function(o){t._players.push({time:i,instr:e,id:o})})}}()}},Beatbox.prototype._clearWebAudioCache=function(t){for(var e=0;e<this._players.length;e++)(null==t||this._players[e].time>=t)&&(this._players[e].instr.stop(this._players[e].id),this._players.splice(e,1),e--)},setTimeout(function(){var t=Howler.ctx.createBufferSource;Howler.ctx.createBufferSource=function(){var e=t.apply(this,arguments),i=e.start;return e.start=function(){return null!=Beatbox._whenOverride&&(arguments[0]=Beatbox._whenOverride),i.apply(this,arguments)},e}},0),"function"==typeof define&&define.amd&&define(["howler"],function(){return Beatbox}),"undefined"!=typeof module&&(module.exports=Beatbox);